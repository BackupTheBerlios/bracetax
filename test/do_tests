#! /bin/sh

test_one()
{
    THE_ONE=$1
    DO_POSTPRO=$2
    PDFLATEX="pdflatex -interaction=nonstopmode"
    bracetax -html -doc -i $THE_ONE.brtx -o ${THE_ONE}_raw.html
    bracetax -html -doc -i $THE_ONE.brtx -o ${THE_ONE}_css.html \
        -link-stylesheet basic.css
    if [ "$DO_POSTPRO" = "postpro" ]; then
        HTMLPP="bracetax -postpro -pp inlinehtml -pp latex2html:hevea"
        $HTMLPP -i ${THE_ONE}_raw.html -o ${THE_ONE}_raw_pp.html
        $HTMLPP -i ${THE_ONE}_css.html -o ${THE_ONE}_css_pp.html
    fi

    # Exports to LaTeX:
    bracetax -doc -latex -i $THE_ONE.brtx -o ${THE_ONE}_latex.tex
    bracetax -doc -latex -i $THE_ONE.brtx -o ${THE_ONE}_latex_style.tex \
        -link-stylesheet bracetax
    # Compile the LaTeX:
    $PDFLATEX ${THE_ONE}_latex
    $PDFLATEX ${THE_ONE}_latex
    $PDFLATEX ${THE_ONE}_latex_style
    $PDFLATEX ${THE_ONE}_latex_style
    if [ "$DO_POSTPRO" = "postpro" ]; then
        LTXPP="bracetax -postpro -pp inlinelatex"
        $LTXPP -i ${THE_ONE}_latex.tex -o ${THE_ONE}_latex_pp.tex
        $LTXPP -i ${THE_ONE}_latex_style.tex -o ${THE_ONE}_latex_style_pp.tex
        $PDFLATEX ${THE_ONE}_latex_pp
        $PDFLATEX ${THE_ONE}_latex_pp
        $PDFLATEX ${THE_ONE}_latex_style_pp
        $PDFLATEX ${THE_ONE}_latex_style_pp
    fi
}

mkdir -p _test_results

# Need an image for the README:
cp `find /usr/share -name "*.png" | head -n 1` _test_results/found_image.png

cp README.brtx test/02_sections.brtx test/01_for_html.brtx test/basic.css \
    test/bracetax.sty test/06_testpostpro.brtx _test_results/

cd _test_results

test_one README
test_one 01_for_html
test_one 02_sections
test_one 06_testpostpro "postpro"

# Post processing

FILES=`find . -name "*.html" -o -name "*.pdf" -o -name "*.log" | sort`
echo "
{header|
    {title|Bracetax's Tests Results}
    {authors|{link http://sebmdt.googlepages.com|Sebastien Mondet}}
    {subtitle|Generated by {t|$0}}
}
Here we have:
{begin list}
$(for f in $FILES ; do
    echo "{item} {link $f}"
done)
{end}
" | bracetax -html -o index.html -doc

